name: Build and Release

on:
  push:
    branches: [ "main" ]

jobs:
  docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            docker.io/codevertex/auth-api:${{ github.sha }}
            docker.io/codevertex/auth-api:latest

      - name: Short SHA
        id: vars
        run: echo "short_sha=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Checkout devops-k8s
        uses: actions/checkout@v4
        with:
          repository: Bengo-Hub/devops-k8s
          token: ${{ secrets.DEVOPS_K8S_ACCESS_TOKEN || secrets.GH_PAT }}
          path: devops-k8s
          fetch-depth: 1

      - name: Ensure auth-api app files exist
        run: |
          mkdir -p devops-k8s/apps/auth-api
          if [ ! -f devops-k8s/apps/auth-api/app.yaml ]; then
            cat > devops-k8s/apps/auth-api/app.yaml <<'YAML'
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: auth-api
            namespace: argocd
          spec:
            project: default
            source:
              repoURL: https://github.com/Bengo-Hub/devops-k8s.git
              targetRevision: main
              path: charts/app
              helm:
                valueFiles:
                  - ../../apps/auth-api/values.yaml
            destination:
              server: https://kubernetes.default.svc
              namespace: auth
            syncPolicy:
              automated:
                prune: true
                selfHeal: true
              syncOptions:
                - CreateNamespace=true
          YAML
          fi
          if [ ! -f devops-k8s/apps/auth-api/values.yaml ]; then
            cat > devops-k8s/apps/auth-api/values.yaml <<'YAML'
          image:
            repository: docker.io/codevertex/auth-api
            tag: latest
            pullSecrets:
              - name: registry-credentials
          service:
            port: 4101
            targetPort: 4101
          healthCheck:
            enabled: true
            readiness:
              httpGet:
                path: /healthz
                port: http
              initialDelaySeconds: 5
              periodSeconds: 10
              timeoutSeconds: 3
            liveness:
              httpGet:
                path: /healthz
                port: http
              initialDelaySeconds: 10
              periodSeconds: 20
              timeoutSeconds: 5
          YAML
          fi

      - name: Trigger devops-k8s sync (using latest tag)
        run: |
          echo "âœ… Image pushed with tags: ${{ github.sha }} and latest"
          echo "ðŸ“¦ docker.io/codevertex/auth-api:latest ready for deployment"
          echo "ðŸ”„ ArgoCD will auto-sync on next refresh cycle"

